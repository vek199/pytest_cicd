# =============================================================================
# Comprehensive CI/CD Pipeline for Learning Pytest and GitHub Actions
# =============================================================================
# 
# This workflow demonstrates:
# - Matrix testing (multiple Python versions and OS)
# - Job dependencies and artifacts
# - Caching for faster builds
# - Code quality checks (linting, formatting, type checking)
# - Test coverage reporting
# - Parallel test execution
# - Manual workflow triggers
# - Environment variables and secrets
# - Conditional job execution
# - Status badges
#
# =============================================================================

name: CI Pipeline

# =============================================================================
# TRIGGER CONDITIONS
# =============================================================================
on:
  # Trigger on push to main branch
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'

  # Trigger on pull requests
  pull_request:
    branches:
      - main
      - develop
    types:
      - opened
      - synchronize
      - reopened

  # Manual trigger with inputs
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow tests'
        required: false
        default: 'false'
        type: boolean
      debug_enabled:
        description: 'Enable debug logging'
        required: false
        default: 'false'
        type: boolean
      python_version:
        description: 'Python version to test'
        required: false
        default: '3.12'
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'

  # Schedule (cron) - run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'

# =============================================================================
# CONCURRENCY CONTROL
# =============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# ENVIRONMENT VARIABLES
# =============================================================================
env:
  PYTHON_DEFAULT_VERSION: '3.12'
  COVERAGE_THRESHOLD: 80
  PYTEST_ADDOPTS: '--color=yes'

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ===========================================================================
  # JOB 1: Code Quality Checks
  # ===========================================================================
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-lint-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-lint-
            ${{ runner.os }}-pip-

      - name: Install linting dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy

      - name: Check code formatting with Black
        run: black --check --diff .

      - name: Check import sorting with isort
        run: isort --check-only --diff .

      - name: Lint with flake8
        run: |
          # Stop the build if there are Python syntax errors or undefined names
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=100 --statistics

      - name: Type check with mypy
        run: mypy --ignore-missing-imports my_math.py
        continue-on-error: true  # Don't fail on type errors for now

  # ===========================================================================
  # JOB 2: Unit Tests with Matrix Strategy
  # ===========================================================================
  test:
    name: Tests (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: lint  # Run after lint job passes
    
    strategy:
      fail-fast: false  # Continue other matrix jobs if one fails
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          # Exclude certain combinations to save CI time
          - os: macos-latest
            python-version: '3.10'
          - os: windows-latest
            python-version: '3.10'
        include:
          # Include additional specific configurations
          - os: ubuntu-latest
            python-version: '3.12'
            coverage: true  # Only collect coverage on one configuration

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~\AppData\Local\pip\Cache
          key: ${{ runner.os }}-pip-${{ matrix.python-version }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ matrix.python-version }}-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests with coverage
        if: matrix.coverage
        run: |
          pytest -v \
            --cov=. \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --cov-fail-under=${{ env.COVERAGE_THRESHOLD }} \
            -m "not slow" \
            --junitxml=test-results.xml

      - name: Run tests without coverage
        if: ${{ !matrix.coverage }}
        run: |
          pytest -v \
            -m "not slow" \
            --junitxml=test-results.xml

      - name: Upload coverage to Codecov
        if: matrix.coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ matrix.python-version }}
          path: test-results.xml
          retention-days: 30

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: matrix.coverage && always()
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 30

  # ===========================================================================
  # JOB 3: Slow Tests (Optional)
  # ===========================================================================
  slow-tests:
    name: Slow Tests
    runs-on: ubuntu-latest
    needs: test
    # Only run on manual trigger with slow tests enabled, or on schedule
    if: >
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.run_slow_tests == 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run slow tests
        run: pytest -v --run-slow -m "slow"

  # ===========================================================================
  # JOB 4: Performance Tests
  # ===========================================================================
  performance:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: test
    # Only run on main branch or manual trigger
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run performance tests
        run: pytest -v -m "performance" --benchmark-only --benchmark-json=benchmark.json
        continue-on-error: true

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results
          path: benchmark.json
          retention-days: 30

  # ===========================================================================
  # JOB 5: Documentation Build
  # ===========================================================================
  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    needs: lint
    # Only build docs on main branch
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install documentation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install sphinx sphinx-rtd-theme

      - name: Build documentation
        run: |
          echo "Documentation build would run here"
          # sphinx-build -b html docs/ docs/_build/html
        continue-on-error: true

  # ===========================================================================
  # JOB 6: Security Scan
  # ===========================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_DEFAULT_VERSION }}

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run bandit security scan
        run: bandit -r . -x ./venv,./tests,./.pytest_cache -ll
        continue-on-error: true

      - name: Check dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --full-report
        continue-on-error: true

  # ===========================================================================
  # JOB 7: Final Status Check
  # ===========================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint, test]
    if: always()

    steps:
      - name: Check all jobs passed
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "Lint job failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "Test job failed"
            exit 1
          fi
          echo "All required jobs passed!"

      - name: Set final status
        run: echo "CI Pipeline completed successfully"

# =============================================================================
# WORKFLOW SUMMARY
# =============================================================================
# 
# Jobs and their dependencies:
#
# ┌──────────┐
# │   lint   │ ────────────────────────────────────────────┐
# └────┬─────┘                                             │
#      │                                                   │
#      ├──────────────────┬────────────────┐              │
#      ▼                  ▼                ▼              ▼
# ┌──────────┐      ┌──────────┐     ┌──────────┐   ┌──────────┐
# │   test   │      │   docs   │     │ security │   │          │
# └────┬─────┘      └──────────┘     └──────────┘   │          │
#      │                                             │          │
#      ├──────────────────┐                          │          │
#      ▼                  ▼                          │          │
# ┌────────────┐   ┌─────────────┐                   │          │
# │ slow-tests │   │ performance │                   │          │
# └────────────┘   └─────────────┘                   │          │
#                                                    │          │
#      ┌─────────────────────────────────────────────┘          │
#      ▼                                                        │
# ┌─────────────┐                                               │
# │ ci-success  │ ◄─────────────────────────────────────────────┘
# └─────────────┘
#
# =============================================================================
